<?php
/**
 * ==========================================================
 * PHP Malware Scanner by Arif & ChatGPT (Safe Version)
 * ==========================================================
 * Fungsi: Imbas semua fail PHP dan cari kod berisiko tinggi
 * Versi: 1.0
 * Lokasi: Letak dalam public_html/
 * ==========================================================
 */

ini_set('max_execution_time', 600);
ini_set('memory_limit', '512M');
error_reporting(0);

echo "<h2>ğŸ” PHP Malware Scanner</h2>";
echo "<p>Mengimbas semua fail PHP dalam folder ini...</p>";

$rootDir = __DIR__;
$suspiciousPatterns = [
    'eval\s*\(',
    'base64_decode\s*\(',
    'shell_exec\s*\(',
    'exec\s*\(',
    'system\s*\(',
    'passthru\s*\(',
    'assert\s*\(',
    'preg_replace\s*\(.*\/e.*\)',
    'gzuncompress\s*\(',
    'str_rot13\s*\(',
    'create_function\s*\(',
    'obfuscate',
    '\$_FILES',
    '\$_POST\[.*\]\s*\(',
    'file_put_contents\s*\(',
    'phpinfo\s*\('
];

$files = new RecursiveIteratorIterator(new RecursiveDirectoryIterator($rootDir));
$totalFiles = 0;
$infectedFiles = [];

foreach ($files as $file) {
    if ($file->isFile() && preg_match('/\.php$/i', $file->getFilename())) {
        $totalFiles++;
        $content = @file_get_contents($file->getPathname());
        if (!$content) continue;

        foreach ($suspiciousPatterns as $pattern) {
            if (preg_match("/$pattern/i", $content)) {
                $infectedFiles[] = $file->getPathname();
                break;
            }
        }
    }
}

echo "<hr><h3>ğŸ“‚ Jumlah fail diimbas: $totalFiles</h3>";

if (count($infectedFiles) > 0) {
    echo "<h3 style='color:red;'>âš ï¸ Fail mencurigakan dijumpai (" . count($infectedFiles) . "):</h3>";
    echo "<ol>";
    foreach ($infectedFiles as $path) {
        echo "<li><b>$path</b><br>";
        echo "<pre style='background:#f3f3f3;padding:8px;border-radius:5px;'>";
        $lines = file($path);
        foreach ($lines as $num => $line) {
            foreach ($suspiciousPatterns as $pattern) {
                if (preg_match("/$pattern/i", $line)) {
                    echo "Baris " . ($num + 1) . ": " . htmlspecialchars(trim($line)) . "\n";
                }
            }
        }
        echo "</pre></li>";
    }
    echo "</ol>";
} else {
    echo "<h3 style='color:green;'>âœ… Tiada fail mencurigakan dijumpai.</h3>";
}

echo "<hr><p>ğŸ’¡ Selesai diimbas pada: <b>" . date('d-m-Y H:i:s') . "</b></p>";
?>
